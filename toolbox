#!/bin/bash

##
# Arquivo: srvtoolbox
# Objetivo: Contem funcoes uteis para o gerenciamento de servidores caseiros
# Criacao: 18/12/2012
##

VERSION="1.0"
LOG_FOLDER="/var/log/toolbox"

# este script so pode ser executado como root.
if [ "$(whoami)" != "root" ] ; then	
	_s=$(which sudo 2>/dev/null)		
	echo "Este script deve ser executado como root:"
	
	if [ -n "$_s" ] ; then
		sudo "$0" $@
	else
		su -c "'$0' $@"
	fi
	exit 0
fi


##
# FUNCTIONS
##

usage(){
	echo "Usage: sh $0 OPTIONS"
	echo ""
	echo "	OPTIONS:"
	echo "	* -h			Mostra esta mensagem"
	echo "	* -v			Mostra a versao do script"
	echo "	* -b	[PARENT_FOLDER]	Backup do systema inteiro, para armazenar na pasta PARENT_FOLDER"
	echo "	* -r			Restore of entire system"
}	

version(){
	echo "toolbox $VERSION"
}

backup(){
	BACKUP_PARENT_FOLDER="$1"
	SRC="/*"
	SNAP="$BACKUP_PARENT_FOLDER/latest"
	DATETAG=$(date +%d-%m-%Y)
	BKP_FOLDER="$BACKUP_PARENT_FOLDER/$DATETAG"
	OPTS="-aAXv --link-dest=$SNAP --exclude=/dev --exclude=/proc --exclude=/sys --exclude=/tmp --exclude=/run --exclude=/mnt --exclude=/media --exclude=/lost+found --exclude=/home/*/.gvfs"
	LOG_BACKUP="$LOG_FOLDER/backup/$DATETAG"
	# run this process with low priority
	ionice -c 3 -p $$
	renice +12 -p $$
	# create the folder if don't exist:
	if [ ! -d "$BACKUP_PARENT_FOLDER" ] ; then
		mkdir -p $BACKUP_PARENT_FOLDER
	fi

	#sync
	START=$(date +%s)

	rsync $OPTS $SRC $BKP_FOLDER > $LOG_BACKUP
	rm -f $SNAP
	ln -s $BKP_FOLDER $SNAP
	
	FINISH=$(date +%s)
	echo "Backup of $DATETAG: $(( ($FINISH-$START) / 60  )) minutes, $((  ($FINISH-$START) % 60 )) seconds" >> $LOG_BACKUP
	
}

restore(){
	echo "restore: $1"
}

##
# MAIN LOOP
##
while getopts hvb:r: OPTION; do
	case "${OPTION}" in
		h) usage;;
		v) version;;
		b) backup ${OPTARG};;
		r) restore ${OPTARG};;
	esac
done		

