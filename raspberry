#!/bin/bash
#
##
# File: backup_raspberry
# Description: Utils for Raspberry Pi.
# Date: 16/01/2014
##
#
#
#
#
# Variables
OPTION=$1
OPTION_2=$2
#
#
#
##
# Configs
##
# Change to your username
USERNAME=giovane
EXT_HD_LOCATION=/mnt
#
#
#
#
#
##
# Constraints
##
VERSION="2.0"
TEMP=$(readlink -f $0)
BASEDIR=$(dirname $TEMP)
TAG="RASPBERRY_UTILS"
HOSTNAME=`hostname`
DST_ROOT=$EXT_HD_LOCATION/backup/raspberry
DROPBOX_UPLOADER=/home/$USERNAME/workspace/Dropbox-Uploader/dropbox_uploader.sh
#
if [ `id -u` != 0 ]
then
logger -t "$TAG" -s "This script must be run as root."
exit 1
fi
#
#
version(){
echo "Raspberry Utils"
echo "Author: Giovane Boaviagem Ribeiro (giovanebribeiro@gmail.com)"
echo "Version: $VERSION"
}
#
_help(){
case $OPTION_2 in
v) 
echo "The script version."
;;
b)
echo "Creates a backup in .img file. Only available in Arch Linux ARM."
echo "Steps: "
echo "1 - Stopping the services"
echo "2 - Executing the backup"
echo "3 - Restaring the services"
;;
s)
echo "Systemd services management."
echo "The services are listed in /etc/services.conf file (one service per line)."
echo "Lines started with '#' are ignored."
echo "If the file don't exist, the file are created automatically."
echo ""
echo "Usage: $0 s [start|stop|status|watchdog]"
echo ""
echo "Internal options:"
echo "start = Start the services"
echo "stop = Stop the services"
echo "status = Show the services status"
echo "watchdog = Restart the stopped services."
;;
*)
echo "Raspberry Utils (For Arch Linux ARM only)"
echo ""
echo "Usage: $0 [option]"
echo "See $0 h [option] for details"
echo ""
echo "Available options:"
echo ""
echo "h = Print this help"
echo "v = Print the version"
echo "b = Backup the raspberry"
echo "s = Services management"
;;
esac
}
#
backup(){
bTAG="$TAG:BACKUP"


MSG1="::: Starting the backup procedures"
MSG2="::: Backup finished"

logger -t $bTAG -s $MSG1

#echo "Rodando a mensagem no pushover..."
#echo "BASEDIR=$BASEDIR"
/bin/bash $BASEDIR/pushover sd cotoco "Backup" "$MSG1"
INIT=$(date +"%s")

logger -t $bTAG -s "::: 1 - Stopping the services"
services "stop"

#if [ ! -d $DST ]
#then
#mkdir -p $DST
#fi

logger -t $bTAG -s "::: 2 - Executing the backup"
NOW=$(date +%d-%m-%Y)

dd bs=1M if=/dev/mmcblk0 of=$DST_ROOT/"$NOW".img

# Compressing the backup file:
#/bin/bash $BASEDIR/pushover sd cotoco "Backup" "Compressing and uploading the backup file"
#tar cf $DST_ROOT/"$NOW".tar $DST_ROOT/"$NOW".img
#rm $DST_ROOT/"$NOW".img
#gzip $DST_ROOT/"$NOW".tar
#rm $DST_ROOT/"$NOW".tar

# Eliminating old files (older than 3 days)
#find $DST_ROOT/* -name "*.tar.gz" -mtime +1 -delete
find $DST_ROOT/* -name "*.img" -mtime +1 -delete

# Dropbox Uploader
#$DROPBOX_UPLOADER -f /home/$USERNAME/.dropbox_uploader upload $DST_ROOT/"$NOW".tar.gz /

logger -t $bTAG -s "::: 3 - Restarting the services"
services "start"

FINISH=$(date +"%s")
DIFF=$(($FINISH-$INIT))
echo "$MSG2 (Execution time: $(($DIFF / 60)) minutes and $(($DIFF % 60)) seconds" >> $BASEDIR/backup.temp
#services "status" >> $BASEDIR/backup.temp
MSG3=`cat $BASEDIR/backup.temp`
rm $BASEDIR/backup.temp
logger -t $bTAG -s $MSG3	
/bin/bash $BASEDIR/pushover sd cotoco "Backup" "$MSG3"
}
#
#
#
#
#
#
#
#
#
#
#
#
restore(){
INIT=$(date +"%s")
rTAG="$TAG:RESTORE"
logger -t $rTAG -s "::: Starting the restore procedures"
sleep 3
logger -t $rTAG -s "::: 1 - Installing the needed packages..."
pacman -Sy rsync ntfs-3g --noconfirm
logger -t $rTAG -s "::: 2 - Mounting the External Hard Drive (located in /dev/sda1)..."
mount -t ntfs-3g /dev/sda1 $EXT_HD_LOCATION
if [ ! -d $DST_ROOT ] 
then
logger -t $rTAG -s "The backup folder ($DST_ROOT) doesn't exist. Nothing to do."
exit 1
fi

logger -t $rTAG -s "::: 3 - Backup options:"
echo "Content of $DST_ROOT: "`ls $DST_ROOT`
echo -n "Set the date for backup (dd-MM-yyyy). [leave empty for latest backup]. The date is the folder name: "
read DATE

TAG="$DATE"
if [ -z $DATE ]
then
TAG="latest"
else
check=$(echo $TAG | sed -e '/[0-9]{2}-[0-9]{2}-[0-9]{4}')
if [[ -z $check ]]
then
logger -t $rTAG -s "$$DATE is the right format"
else
logger -t $rTAG -s "The date isn't in the right format. Please use dd-MM-yyyy"
exit 1
fi
fi
SRC=$DST_ROOT/$TAG
logger -t $rTAG -s "::: 4 - Starting the restore (src folder: $SRC)"
rsync $RSYNC_OPTIONS --progress $SRC/* /
chown $USERNAME:users $EXT_HD_LOCATION

logger -t $rTAG -s "::: 5 - System upgrade"
pacman -Syu --noconfirm

logger -t $rTAG -s "::: 6 - Deleting the ssh keys to restart the server"

logger -t $bTAG -s "::: 6 - Starting the services"
services "start"

FINISH=$(date +"%s")
DIFF=$(($FINISH-$INIT))
echo "::: Restore finished (Execution time: $(($DIFF / 60)) minutes and $(($DIFF % 60)) seconds"
}
#
#
#
#
#
#
#
#
#
#
#
#
services(){
FILECONF=/etc/services.conf

#
if [ ! -z $1 ]
then
OPTION_2=$1
fi

#
if [ ! -f $FILECONF ] ; then
echo "##" >> $FILECONF
echo "# File: /etc/services.conf" >> $FILECONF
echo "# List of services controled by script 'services' " >> $FILECONF
echo "# Must be one service per line" >> $FILECONF
echo "# All the services are controlled by 'systemd'" >> $FILECONF
echo "# Lines preceded by '#' are ignored" >> $FILECONF
echo "##" >> $FILECONF
echo "" >> $FILECONF
echo "#cronie" >> $FILECONF
echo "#transmission" >> $FILECONF
 
echo "File $FILECONF created. Edit this file to use this script in future."
exit 1
fi

#
systemctl daemon-reload

#
case $OPTION_2 in
start)
while read line
do
if [ ! ${line:0:1} == '#' ] ; then
echo "Starting service: $line"
systemctl start $line
fi
done < $FILECONF
;;
stop)
while read line
do
if [ ! ${line:0:1} == '#' ] ; then
echo "Terminating service: $line"
systemctl stop $line
fi
done < $FILECONF
;;
status)
while read line
do
if [ ! ${line:0:1} == '#' ] ; then
RESP=`systemctl status $line | grep -i -m 1 "Active"`
echo "### $line - " $RESP >> ~/temp
fi
done < $FILECONF
cat ~/temp
rm ~/temp
;;
watchdog)
while read line
do
if [ ! ${line:0:1} == '#' ] ; then
echo "Check status of service: $line"
RESP=`systemctl status $line | grep -i -m 1 "\(running\)"`
if [ "$RESP" == "" ] ; then
echo "Restarting service $line"
systemctl restart $line
fi
sleep 10
fi
done < $FILECONF
;;
*)
echo "Usage: $0 s [options]"
echo ""
echo "Options:"
echo "* start: Start all the services present in file /etc/services.conf"
echo "* stop: Stop all the services present in file /etc/services.conf"
echo "* status: Check the status of all the services"
echo "* watchdog: for each file present in /etc/services.conf; if the service is out, restart it."
;;
esac
}
#
#
#
#
case $OPTION in
h) _help ;;
v) version ;;
b) backup ;;
#r) restore ;;
s) services ;;
*)
logger -t $TAG -s "Incorrect option."
_help
;;
esac

