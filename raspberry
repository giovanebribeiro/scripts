#!/bin/bash

##
# File: backup_raspberry
# Description: Utils for Raspberry Pi.
# Date: 16/01/2014
##

##
# Configs
##
# Backup's image directory
EXT_HD_LOCATION=/mnt
PUSHOVER_DIR=/home/giovane/scripts
#
#
#
##
# Not change behind this point...
##
TAG="RASPBERRY_UTILS"
HOSTNAME=`hostname`
#
# -r = recursive into directories
# -l = copy symlinks as symlinks
# -t = preserve modification times
# -W = copy files whole (w/o delta-xfer algorithm)
# -D = preserve device files
# -E = preserve executability
# -g = preserve group
# -o = preserve owner
# -p = preserve permissions
#
RSYNC_OPTIONS="--force -rltWDEgop"
DST_ROOT=$EXT_HD_LOCATION/backup/$HOSTNAME
VERSION="01.00"
#
#
#
if [ `id -u` != 0 ]
then
        logger -t "$TAG" -s "This script must be run as root."
        exit 1
fi
#
#
#
if ! rsync --version > /dev/null
then
        logger -t $TAG -s "This script needs rsync to run properly."
        exit 0
fi
#
#
#
version(){
echo "Raspberry Utils"
echo "Author: Giovane Boaviagem Ribeiro (giovanebribeiro@gmail.com)"
echo "Version: $VERSION"
}
#
#
#
_help(){
echo "Raspberry Utils (For Arch Linux ARM only)"
echo ""
echo "Usage: $0 [options]"
echo ""
echo "-h = Print this help"
echo "-v = Print the version"
echo "-b = Backup the raspberry (Using rsync)"
echo "-r = Restore the raspberry (Using rsync)"
}
#
# Backup function.
# Creates a backup in snapshot-tree.
# If the file changes 20 times, create a hardlink.
#
backup(){
        DST="$DST_ROOT/latest"
        MINCHANGES=20

        bTAG="$TAG:BACKUP"
	MSG1="::: Starting the backup procedures"
        MSG2="::: Backup finished"

	logger -t $bTAG -s "::: 1 - Stopping the services"
	/bin/bash $PUSHOVER_DIR/services stop

        logger -t $bTAG -s $MSG1
        INIT=$(date +"%s")

        if [ ! -d $DST ]
        then
                mkdir -p $DST
        fi

        # Run this process with low priority.
#        ionice -c 3 -p $$
#        renice +12 -p $$

        # sync
        rsync $RSYNC_OPTIONS \
                --delete \
                --exclude '/dev' \
                --exclude '/media' \
                --exclude '/mnt' \
                --exclude '/proc' \
                --exclude '/run' \
                --exclude '/sys' \
                --exclude '/tmp' \
                --exclude '/lost\+found' \
                / $DST >> $DST_ROOT/rsync.log
 
        logger -t $TAG -s "::: 2 - Checking if enough has changed to create a hardlink."
        if [ -e $DST_ROOT/rsync.log ]
        then
                COUNT=$( wc -l $DST_ROOT/rsync.log | cut -d" " -f1 )
                if [ $COUNT -gt $MINCHANGES ]
               then
                        NOW=$(date +%d-%m-%Y)
                        if [ ! -e $DST_ROOT/$NOW ]
                        then
                                cp -al $DST $DST_ROOT/$NOW
                                chmod u+w $DST_ROOT/$NOW
                                mv $DST_ROOT/rsync.log $DST_ROOT/$NOW/rsync.log
                                chmod u-w $DST_ROOT/$NOW
                        fi
                fi
        fi

        FINISH=$(date +"%s")
        DIFF=$(($FINISH-$INIT))

	logger -t $bTAG -s "::: 3 - Restarting the services"
	/bin/bash $PUSHOVER_DIR/services start

        echo "$MSG2 (Execution time: $(($DIFF / 60)) minutes and $(($DIFF % 60)) seconds" >> ~/backup.temp
	echo `/bin/bash $PUSHOVER_DIR/services status` >> ~/backup.temp
	MSG3=`cat ~/backup.temp`
	rm ~/backup.temp
	logger -t $bTAG -s $MSG3	
        /bin/bash $PUSHOVER_DIR/pushover sd cotoco "Backup" "$MSG3"
}

restore(){
	INIT=$(date +"%s")

        rTAG="$TAG:RESTORE"
	logger -t $rTAG -s "::: Starting the restore procedures"
	sleep 3
	logger -t $rTAG -s "::: 1 - Installing the needed packages..."
	pacman -Sy rsync ntfs-3g --noconfirm
	logger -t $rTAG -s "::: 2 - Mounting the External Hard Drive (located in /dev/sda1)..."
	mount -t ntfs-3g /dev/sda1 /mnt
	if [ ! -d $DST_ROOT ] 
	then
		logger -t $rTAG "The backup folder ($DST_ROOT) doesn't exist. Nothing to do."
		exit 1
	fi

	logger -t $rTAG -s "::: 3 - Backup options:"
	echo `ls $DST_ROOT`
        echo -n "Set the data for backup (dd-MM-yyyy) [leave empty for latest backup]"
        read DATE

        TAG="$DATE"
        if [ -z $DATE ]
        then
                TAG="latest"
        else
                check=$(echo $TAG | sed -e '/[0-9]{2}-[0-9]{2}-[0-9]{4}')
                if [[ -z $check ]]
                then
                        logger -t $rTAG -s "$$DATE is the right format"
                else
                        logger -t $rTAG -s "The date isn't in the right format. Please use dd-MM-yyyy"
                        exit 1
                fi
        fi
	INIT=$(date +"%s")
        SRC=$DST_ROOT/$TAG
        logger -t $rTAG -s "::: 4 - Starting the restore (src folder: $SRC)"
        rsync $RSYNC_OPTIONS $SRC /
	FINISH=$(date +"%s")
        DIFF=$(($FINISH-$INIT))

	logger -t $rTAG -s "::: 5 - System upgrade"
	pacman -Syu --noconfirm

	logger -t $bTAG -s "::: 6 - Starting the services"
	/bin/bash $PUSHOVER_DIR/services start

	FINISH=$(date +"%s")
        DIFF=$(($FINISH-$INIT))
        echo "::: Restore finished (Execution time: $(($DIFF / 60)) minutes and $(($DIFF % 60)) seconds"
}

case $1 in
        -h) _help ;;
        -v) version ;;
        -b) backup ;;
        -r) restore ;;
        *)
                logger -t $TAG -s "Incorrect option."
                help
                ;;
esac

